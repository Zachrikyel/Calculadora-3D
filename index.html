import React, { useState, useEffect } from 'react';
import { Printer, Zap, Package, Clock, DollarSign, TrendingUp, Share2, ArrowLeft, ChevronLeft, ChevronRight, Trash2, Plus, AlertCircle, Snowflake, Box, Truck, Sparkles } from 'lucide-react';

const PRINTERS = [
  { id: 'p1s', name: 'Bambu Lab P1S', watts: 300, wear: 800 },
  { id: 'a1', name: 'Bambu Lab A1', watts: 110, wear: 500 },
  { id: 'x1c', name: 'Bambu Lab X1C', watts: 350, wear: 1200 }
];

const NOZZLES = [
  { size: 0.2, riskFactor: 1.15, label: '0.2mm (Alto riesgo)' },
  { size: 0.4, riskFactor: 1.0, label: '0.4mm (Est√°ndar)' },
  { size: 0.6, riskFactor: 1.05, label: '0.6mm (Riesgo medio)' },
  { size: 0.8, riskFactor: 1.10, label: '0.8mm (Riesgo alto)' }
];

const MATERIALS = [
  { id: 'pla', name: 'PLA', coolMinutes: 18, amsRisk: 1.03 },
  { id: 'petg', name: 'PETG', coolMinutes: 25, amsRisk: 1.05 },
  { id: 'abs', name: 'ABS', coolMinutes: 30, amsRisk: 1.04 },
  { id: 'tpu', name: 'TPU', coolMinutes: 10, amsRisk: 1.08 }
];

const SHIPPING_OPTIONS = [
  { id: 'pickup', name: 'Recogida', cost: 0, icon: 'üè™' },
  { id: 'local', name: 'Local', cost: 15000, icon: 'üì¶' },
  { id: 'national', name: 'Nacional', cost: 20000, icon: 'üöö' }
];

const PACKAGING = [
  { id: 'bag', name: 'Sobre/Bolsa', cost: 1500 },
  { id: 'standard', name: 'Caja Est√°ndar', cost: 3000 },
  { id: 'reinforced', name: 'Caja Reforzada', cost: 7000 }
];

const GATEWAYS = [
  { id: 'nequi', name: 'Nequi/Transferencia', rate: 0 },
  { id: 'wompi', name: 'Wompi', rate: 2.65, iva: true },
  { id: 'bold', name: 'Bold (Datafono)', rate: 5 }
];

function BomForm({ onSubmit, onCancel }) {
  const [name, setName] = useState('');
  const [cost, setCost] = useState('');

  const handleSubmit = () => {
    if (name && cost) {
      onSubmit(name, cost);
      setName('');
      setCost('');
    }
  };

  return (
    <div className="space-y-4">
      <div>
        <label className="block text-sm text-zinc-400 mb-2">Nombre</label>
        <input
          type="text"
          value={name}
          onChange={(e) => setName(e.target.value)}
          placeholder="ej. Imanes, Tornillos..."
          className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-cyan-500"
        />
      </div>
      <div>
        <label className="block text-sm text-zinc-400 mb-2">Costo (COP)</label>
        <input
          type="number"
          value={cost}
          onChange={(e) => setCost(e.target.value)}
          placeholder="5000"
          className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-cyan-500"
        />
      </div>
      <div className="flex gap-3 pt-2">
        <button
          onClick={onCancel}
          className="flex-1 py-3 rounded-lg border border-zinc-700 text-zinc-400"
        >
          Cancelar
        </button>
        <button
          onClick={handleSubmit}
          className="flex-1 py-3 rounded-lg bg-cyan-500 text-white font-bold"
        >
          Agregar
        </button>
      </div>
    </div>
  );
}

export default function SICMACalculator() {
  const [step, setStep] = useState(1);
  const [config, setConfig] = useState({
    kwhPrice: 920,
    printer: 'p1s',
    nozzle: 0.4,
    material: 'pla',
    amsMode: false
  });

  const [print, setPrint] = useState({
    printHours: 0,
    materialCost: 0
  });

  const [labor, setLabor] = useState({
    complexity: 10,
    bom: []
  });

  const [logistics, setLogistics] = useState({
    shipping: 'pickup',
    packaging: 'standard',
    gateway: 'nequi',
    profitMargin: 60
  });

  const [results, setResults] = useState(null);
  const [showBomDialog, setShowBomDialog] = useState(false);

  const updateConfig = (key, value) => {
    const newConfig = { ...config, [key]: value };
    
    // Auto-update cooling time when material changes
    if (key === 'material') {
      const material = MATERIALS.find(m => m.id === value);
      setPrint(prev => ({ ...prev, coolMinutes: material.coolMinutes }));
    }
    
    setConfig(newConfig);
  };

  const updatePrint = (key, value) => setPrint(prev => ({ ...prev, [key]: value }));
  const updateLabor = (key, value) => setLabor(prev => ({ ...prev, [key]: value }));
  const updateLogistics = (key, value) => setLogistics(prev => ({ ...prev, [key]: value }));

  // Initialize cooling time on mount
  useEffect(() => {
    const material = MATERIALS.find(m => m.id === config.material);
    setPrint(prev => ({ ...prev, coolMinutes: material.coolMinutes }));
  }, []);

  const addBomItem = (name, cost) => {
    setLabor(prev => ({
      ...prev,
      bom: [...prev.bom, { id: Date.now(), name, cost: parseFloat(cost) }]
    }));
    setShowBomDialog(false);
  };

  const removeBomItem = (id) => {
    setLabor(prev => ({
      ...prev,
      bom: prev.bom.filter(item => item.id !== id)
    }));
  };

  const parseDecimalHours = (hours) => {
    const h = Math.floor(hours);
    const m = Math.round((hours - h) * 60);
    return { hours: h, minutes: m };
  };

  const calculate = () => {
    const printer = PRINTERS.find(p => p.id === config.printer);
    const material = MATERIALS.find(m => m.id === config.material);
    const nozzle = NOZZLES.find(n => n.size === config.nozzle);
    const shipping = SHIPPING_OPTIONS.find(s => s.id === logistics.shipping);
    const packaging = PACKAGING.find(p => p.id === logistics.packaging);
    const gateway = GATEWAYS.find(g => g.id === logistics.gateway);

    // Tiempo total
    const totalPrintHours = print.printHours;
    const coolMinutes = print.coolMinutes || material.coolMinutes;
    const totalCoolHours = coolMinutes / 60;
    const totalOccupancyHours = totalPrintHours + totalCoolHours;

    // Costos duros
    const costEnergy = ((printer.watts * totalPrintHours) + (printer.watts * 0.1 * totalCoolHours)) / 1000 * config.kwhPrice;
    const costWear = printer.wear * totalOccupancyHours;
    
    // Material: Ya viene calculado de Bambu Studio
    // Aplicamos factor de riesgo de nozzle y AMS
    let costMaterial = print.materialCost;
    costMaterial *= nozzle.riskFactor; // Riesgo por nozzle
    if (config.amsMode) {
      costMaterial *= material.amsRisk; // Riesgo adicional por AMS
    }
    
    const hardCosts = costEnergy + costWear + costMaterial;

    // Costos blandos
    const baseLaborCost = 20000; // Costo base por proyecto
    const complexityMultiplier = 1 + (labor.complexity / 100);
    const costLabor = baseLaborCost * complexityMultiplier;
    
    const costBomRaw = labor.bom.reduce((acc, item) => acc + item.cost, 0);
    const costBom = costBomRaw * 1.15;
    
    const softCosts = costLabor + costBom;

    // Log√≠stica
    const logisticsCosts = shipping.cost + packaging.cost;

    // Costo base total
    const baseCost = hardCosts + softCosts + logisticsCosts;

    // Precio de venta (lo que queremos ganar)
    const marginDecimal = logistics.profitMargin / 100;
    const sellPrice = baseCost / (1 - marginDecimal);

    // Ajuste por pasarela de pago
    let finalPrice = 0;
    let feeEstimate = 0;

    if (gateway.id === 'wompi') {
      // Wompi: 2.65% + IVA (19% sobre la comisi√≥n)
      // Fee = sellPrice * 2.65% * 1.19 = sellPrice * 0.031535
      // Para que el vendedor reciba sellPrice, debe cobrar:
      // finalPrice = sellPrice / (1 - 0.031535) = sellPrice / 0.968465
      const wompiRate = 0.0265 * 1.19; // 0.031535
      finalPrice = sellPrice / (1 - wompiRate);
      feeEstimate = finalPrice - sellPrice;
    } else if (gateway.id === 'bold') {
      finalPrice = sellPrice / 0.95;
      feeEstimate = finalPrice - sellPrice;
    } else {
      finalPrice = sellPrice;
      feeEstimate = 0;
    }

    // Redondeo
    finalPrice = Math.ceil(finalPrice / 100) * 100;
    
    // Ganancia neta: Es el sellPrice menos los costos
    // (El feeEstimate ya est√° incluido en finalPrice, as√≠ que netProfit es limpio)
    const netProfit = sellPrice - baseCost;

    setResults({
      finalPrice,
      hardCosts,
      softCosts,
      logisticsCosts,
      netProfit,
      feeEstimate,
      sellPrice, // Precio antes de comisi√≥n
      breakdown: {
        energy: costEnergy,
        wear: costWear,
        material: costMaterial,
        labor: costLabor,
        bom: costBom
      }
    });
  };

  const shareQuote = () => {
    const txt = `*COTIZACI√ìN 3D PROFESIONAL*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n‚è±Ô∏è Tiempo: ${print.printHours.toFixed(1)}h\nüöö Env√≠o incluido\nüí≥ Pago digital disponible\n\nüí∞ *TOTAL: $${results.finalPrice.toLocaleString('es-CO')} COP*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n‚ú® Tu ganancia neta: $${results.netProfit.toLocaleString('es-CO')}\nüìä Margen: ${logistics.profitMargin}%\n_Validez: 5 d√≠as_`;
    navigator.clipboard.writeText(txt).then(() => {
      alert('‚úÖ ¬°Cotizaci√≥n copiada al portapapeles!');
    });
  };

  const saveToHistory = async () => {
    try {
      const quote = {
        id: Date.now(),
        date: new Date().toISOString(),
        config,
        print,
        labor,
        logistics,
        results
      };
      
      const historyKey = 'sicma-history';
      let history = [];
      
      try {
        const stored = await window.storage.get(historyKey);
        if (stored && stored.value) {
          history = JSON.parse(stored.value);
        }
      } catch (e) {
        // No hay historial previo
      }
      
      history.unshift(quote);
      history = history.slice(0, 20);
      
      await window.storage.set(historyKey, JSON.stringify(history));
      
      // Tambi√©n copiar al portapapeles
      const txt = `üìã COTIZACI√ìN GUARDADA #${quote.id}\n${new Date(quote.date).toLocaleString('es-CO')}\n\nPrecio: $${results.finalPrice.toLocaleString('es-CO')}\nGanancia: $${results.netProfit.toLocaleString('es-CO')}\nMargen: ${logistics.profitMargin}%`;
      navigator.clipboard.writeText(txt);
      
      alert('‚úÖ ¬°Guardado en el historial y copiado al portapapeles!');
    } catch (error) {
      console.error('Error guardando:', error);
      alert('‚ö†Ô∏è Error al guardar. Datos copiados al portapapeles como respaldo.');
    }
  };

  const resetCalculator = () => {
    setStep(1);
    setConfig({
      kwhPrice: 920,
      printer: 'p1s',
      nozzle: 0.4,
      material: 'pla',
      amsMode: false
    });
    setPrint({
      printHours: 0,
      materialCost: 0,
      coolMinutes: 18
    });
    setLabor({
      complexity: 10,
      bom: []
    });
    setLogistics({
      shipping: 'pickup',
      packaging: 'standard',
      gateway: 'nequi',
      profitMargin: 60
    });
    setResults(null);
  };

  const nextStep = () => {
    if (step === 4) {
      calculate();
      setStep(5);
    } else if (step < 5) {
      setStep(step + 1);
    }
  };

  const prevStep = () => {
    if (step > 1) setStep(step - 1);
  };

  const getProgress = () => (step / 5) * 100;

  const selectedPrinter = PRINTERS.find(p => p.id === config.printer);
  const selectedMaterial = MATERIALS.find(m => m.id === config.material);
  const selectedNozzle = NOZZLES.find(n => n.size === config.nozzle);

  return (
    <div className="min-h-screen bg-zinc-950 text-zinc-100 flex flex-col">
      {/* Header */}
      <header className="bg-zinc-900 border-b border-zinc-800 p-4 sticky top-0 z-50">
        <div className="flex items-center justify-between max-w-md mx-auto">
          <div>
            <h1 className="text-lg font-bold text-cyan-400 tracking-wider">SICMA</h1>
            <p className="text-xs text-zinc-500 font-mono">Calculadora Pro v2.0</p>
          </div>
          <div className="text-right">
            <div className="text-3xl font-bold text-white">{step}</div>
            <div className="text-xs text-zinc-500">/5</div>
          </div>
        </div>
        
        {/* Progress Bar */}
        <div className="max-w-md mx-auto mt-3">
          <div className="h-1 bg-zinc-800 rounded-full overflow-hidden">
            <div 
              className="h-full bg-gradient-to-r from-cyan-500 to-purple-500 transition-all duration-500"
              style={{ width: `${getProgress()}%` }}
            />
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="flex-1 overflow-y-auto pb-24">
        <div className="max-w-md mx-auto p-5">
          
          {/* Step 1: Hardware */}
          {step === 1 && (
            <div className="space-y-5 animate-fade-in">
              <h2 className="text-2xl font-bold text-white mb-6">‚öôÔ∏è Configuraci√≥n</h2>
              
              {/* Costo Energ√≠a */}
              <div className="bg-zinc-900 rounded-2xl p-5 border border-zinc-800">
                <label className="block text-sm text-zinc-400 mb-2">
                  <Zap className="inline w-4 h-4 mr-1" />
                  Costo Luz (COP/kWh)
                </label>
                <input
                  type="number"
                  value={config.kwhPrice}
                  onChange={(e) => updateConfig('kwhPrice', parseFloat(e.target.value))}
                  className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-xl font-bold text-cyan-400 focus:outline-none focus:border-cyan-500"
                />
                <p className="text-xs text-zinc-500 mt-2">üí° Recomendado: ~920 COP (incluye franja pico 6pm-10pm)</p>
              </div>

              {/* Impresora */}
              <div className="bg-zinc-900 rounded-2xl p-5 border border-zinc-800">
                <div className="flex items-center justify-between mb-3">
                  <Printer className="text-cyan-400" size={24} />
                  <span className="text-xs font-mono text-cyan-400 bg-zinc-800 px-2 py-1 rounded">HARDWARE</span>
                </div>
                
                <label className="block text-sm text-zinc-400 mb-2">Impresora</label>
                <select
                  value={config.printer}
                  onChange={(e) => updateConfig('printer', e.target.value)}
                  className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white font-semibold focus:outline-none focus:border-cyan-500 mb-4"
                >
                  {PRINTERS.map(p => (
                    <option key={p.id} value={p.id}>{p.name}</option>
                  ))}
                </select>

                <div className="flex justify-between text-xs font-mono">
                  <span className="text-zinc-500">Consumo: <span className="text-white font-bold">{selectedPrinter.watts}W</span></span>
                  <span className="text-zinc-500">Desgaste: <span className="text-white font-bold">${selectedPrinter.wear}/h</span></span>
                </div>

                <div className="mt-4 pt-4 border-t border-zinc-800">
                  <label className="block text-sm text-zinc-400 mb-2">Boquilla (Nozzle)</label>
                  <div className="grid grid-cols-2 gap-2">
                    {NOZZLES.map(nozzle => (
                      <button
                        key={nozzle.size}
                        onClick={() => updateConfig('nozzle', nozzle.size)}
                        className={`py-2 px-3 rounded-lg border-2 transition text-sm ${
                          config.nozzle === nozzle.size 
                            ? 'border-cyan-500 bg-cyan-500/10 text-cyan-400' 
                            : 'border-zinc-700 text-zinc-400'
                        }`}
                      >
                        {nozzle.size}mm
                      </button>
                    ))}
                  </div>
                  <p className="text-xs text-zinc-600 mt-2">
                    ‚ö†Ô∏è Riesgo actual: +{((selectedNozzle.riskFactor - 1) * 100).toFixed(0)}%
                  </p>
                </div>
              </div>

              {/* Material */}
              <div className="bg-zinc-900 rounded-2xl p-5 border border-zinc-800">
                <label className="block text-sm text-zinc-400 mb-2">Material</label>
                <select
                  value={config.material}
                  onChange={(e) => updateConfig('material', e.target.value)}
                  className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white font-semibold focus:outline-none focus:border-cyan-500 mb-4"
                >
                  {MATERIALS.map(m => (
                    <option key={m.id} value={m.id}>{m.name}</option>
                  ))}
                </select>

                <div className="flex items-center justify-between p-3 bg-zinc-800 rounded-lg">
                  <div className="flex items-center gap-2">
                    <Sparkles className="text-purple-400" size={18} />
                    <span className="text-sm">Modo AMS (Multicolor)</span>
                  </div>
                  <button
                    onClick={() => updateConfig('amsMode', !config.amsMode)}
                    className={`w-12 h-6 rounded-full transition relative ${config.amsMode ? 'bg-cyan-500' : 'bg-zinc-700'}`}
                  >
                    <div className={`absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition ${config.amsMode ? 'translate-x-6' : ''}`} />
                  </button>
                </div>
                
                {config.amsMode && (
                  <div className="flex items-start gap-2 mt-3 p-2 bg-orange-500/10 border border-orange-500/30 rounded-lg">
                    <AlertCircle size={14} className="mt-0.5 flex-shrink-0 text-orange-400" />
                    <span className="text-xs text-orange-400">
                      Riesgo adicional de +{((selectedMaterial.amsRisk - 1) * 100).toFixed(0)}% por purga AMS
                    </span>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Step 2: Print Data */}
          {step === 2 && (
            <div className="space-y-5 animate-fade-in">
              <h2 className="text-2xl font-bold text-white mb-6">‚è±Ô∏è Datos de Impresi√≥n</h2>
              
              {/* Tiempo */}
              <div className="bg-zinc-900 rounded-2xl p-5 border border-zinc-800">
                <label className="block text-sm text-zinc-400 mb-4 flex items-center gap-2">
                  <Clock className="w-4 h-4" />
                  Tiempo de Impresi√≥n (desde Bambu Studio)
                </label>
                
                <div className="bg-zinc-800 rounded-xl p-6 text-center mb-4">
                  <input
                    type="number"
                    step="0.1"
                    value={print.printHours || ''}
                    onChange={(e) => updatePrint('printHours', parseFloat(e.target.value) || 0)}
                    className="w-full bg-transparent text-center text-5xl font-bold text-white focus:outline-none"
                    placeholder="0.0"
                  />
                  <div className="text-sm text-zinc-500 mt-2">horas (ej: 6.7 = 6h 42min)</div>
                </div>

                {print.printHours > 0 && (
                  <div className="text-center text-xs text-cyan-400 font-mono bg-cyan-500/10 p-2 rounded-lg mb-4">
                    ‚âà {parseDecimalHours(print.printHours).hours}h {parseDecimalHours(print.printHours).minutes}min
                  </div>
                )}

                <div className="pt-4 border-t border-zinc-800">
                  <label className="block text-sm text-zinc-400 mb-2 flex items-center gap-2">
                    <Snowflake className="w-4 h-4" />
                    Enfriamiento (autom√°tico seg√∫n material)
                  </label>
                  <input
                    type="number"
                    value={print.coolMinutes || selectedMaterial.coolMinutes}
                    onChange={(e) => updatePrint('coolMinutes', parseInt(e.target.value) || 0)}
                    className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-lg font-bold text-white focus:outline-none focus:border-cyan-500"
                  />
                  <p className="text-xs text-zinc-500 mt-2">
                    Recomendado para {selectedMaterial.name}: {selectedMaterial.coolMinutes} min
                  </p>
                </div>
              </div>

              {/* Costo Material */}
              <div className="bg-zinc-900 rounded-2xl p-5 border border-zinc-800">
                <label className="block text-sm text-zinc-400 mb-4 flex items-center gap-2">
                  <Package className="w-4 h-4" />
                  Costo Material (desde Bambu Studio)
                </label>
                
                <div className="bg-zinc-800 rounded-xl p-4 mb-3">
                  <div className="text-xs text-zinc-500 mb-2">Costo Total Material (COP)</div>
                  <input
                    type="number"
                    value={print.materialCost || ''}
                    onChange={(e) => updatePrint('materialCost', parseFloat(e.target.value) || 0)}
                    className="w-full bg-transparent text-right text-3xl font-bold text-cyan-400 focus:outline-none"
                    placeholder="0"
                  />
                </div>

                <div className="bg-zinc-800/50 rounded-lg p-3 text-xs text-zinc-500">
                  üí° Bambu Studio muestra el costo total del material usado (modelo + soportes + purga). Usa ese valor.
                </div>
              </div>
            </div>
          )}

          {/* Step 3: Labor */}
          {step === 3 && (
            <div className="space-y-5 animate-fade-in">
              <h2 className="text-2xl font-bold text-white mb-6">üë§ Complejidad & Hardware</h2>
              
              {/* Complejidad */}
              <div className="bg-zinc-900 rounded-2xl p-5 border border-zinc-800">
                <div className="flex justify-between items-center mb-4">
                  <label className="text-sm text-zinc-400">Complejidad T√©cnica</label>
                  <span className="text-2xl font-bold text-cyan-400">{labor.complexity}%</span>
                </div>
                
                <input
                  type="range"
                  min="10"
                  max="100"
                  step="10"
                  value={labor.complexity}
                  onChange={(e) => updateLabor('complexity', parseInt(e.target.value))}
                  className="w-full h-2 bg-zinc-800 rounded-lg appearance-none cursor-pointer accent-cyan-500"
                />
                
                <div className="flex justify-between text-xs text-zinc-600 mt-3 px-1">
                  <span>F√°cil</span>
                  <span>Medio</span>
                  <span>Experto</span>
                  <span>Imposible</span>
                </div>

                <div className="mt-6 p-3 bg-zinc-800/50 rounded-lg text-xs space-y-2">
                  <div className="flex justify-between text-zinc-400">
                    <span>Costo base:</span>
                    <span className="text-white font-mono">$20.000</span>
                  </div>
                  <div className="flex justify-between text-zinc-400">
                    <span>Con complejidad {labor.complexity}%:</span>
                    <span className="text-cyan-400 font-mono font-bold">
                      ${(20000 * (1 + labor.complexity / 100)).toFixed(0).toLocaleString('es-CO')}
                    </span>
                  </div>
                </div>

                <div className="mt-4 p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg text-xs text-blue-400">
                  ‚ÑπÔ∏è La complejidad incluye setup, calibraci√≥n, post-proceso y dificultad t√©cnica
                </div>
              </div>

              {/* BOM */}
              <div className="bg-zinc-900 rounded-2xl p-5 border border-zinc-800">
                <h3 className="text-sm font-bold text-white mb-3 flex items-center gap-2">
                  <Box className="w-4 h-4" />
                  Hardware Adicional (BOM)
                </h3>
                
                <div className="space-y-2 mb-3">
                  {labor.bom.length === 0 ? (
                    <div className="text-xs text-zinc-500 italic text-center py-4">
                      Sin componentes adicionales
                    </div>
                  ) : (
                    labor.bom.map(item => (
                      <div key={item.id} className="flex justify-between items-center bg-zinc-800 p-3 rounded-lg border border-zinc-700">
                        <span className="text-sm">{item.name}</span>
                        <div className="flex items-center gap-3">
                          <span className="text-sm font-mono text-zinc-400">${item.cost.toLocaleString('es-CO')}</span>
                          <button
                            onClick={() => removeBomItem(item.id)}
                            className="text-red-400 hover:text-red-300"
                          >
                            <Trash2 size={16} />
                          </button>
                        </div>
                      </div>
                    ))
                  )}
                </div>

                <button
                  onClick={() => setShowBomDialog(true)}
                  className="w-full py-3 bg-zinc-800 rounded-lg text-sm text-cyan-400 border border-zinc-700 hover:border-cyan-500 flex items-center justify-center gap-2"
                >
                  <Plus size={18} />
                  Agregar Componente
                </button>
              </div>
            </div>
          )}

          {/* Step 4: Logistics */}
          {step === 4 && (
            <div className="space-y-5 animate-fade-in">
              <h2 className="text-2xl font-bold text-white mb-6">üì¶ Log√≠stica</h2>
              
              {/* Env√≠o */}
              <div className="bg-zinc-900 rounded-2xl p-5 border border-zinc-800">
                <label className="block text-sm text-zinc-400 mb-3 flex items-center gap-2">
                  <Truck className="w-4 h-4" />
                  M√©todo de Env√≠o
                </label>
                
                <div className="space-y-2">
                  {SHIPPING_OPTIONS.map(option => (
                    <button
                      key={option.id}
                      onClick={() => updateLogistics('shipping', option.id)}
                      className={`w-full p-4 rounded-xl border-2 transition flex items-center justify-between ${
                        logistics.shipping === option.id
                          ? 'border-cyan-500 bg-cyan-500/10'
                          : 'border-zinc-700 bg-zinc-800'
                      }`}
                    >
                      <div className="flex items-center gap-3">
                        <div className="text-2xl">{option.icon}</div>
                        <div className="text-left">
                          <div className="text-sm font-semibold">{option.name}</div>
                        </div>
                      </div>
                      <div className="text-sm font-bold">
                        {option.cost === 0 ? 'Gratis' : `$${option.cost.toLocaleString('es-CO')}`}
                      </div>
                    </button>
                  ))}
                </div>
              </div>

              {/* Embalaje */}
              <div className="bg-zinc-900 rounded-2xl p-5 border border-zinc-800">
                <label className="block text-sm text-zinc-400 mb-3">Embalaje</label>
                <select
                  value={logistics.packaging}
                  onChange={(e) => updateLogistics('packaging', e.target.value)}
                  className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white font-semibold focus:outline-none focus:border-cyan-500"
                >
                  {PACKAGING.map(p => (
                    <option key={p.id} value={p.id}>
                      {p.name} - ${p.cost.toLocaleString('es-CO')}
                    </option>
                  ))}
                </select>
              </div>

              {/* Finanzas */}
              <div className="bg-zinc-900 rounded-2xl p-5 border border-zinc-800">
                <label className="block text-sm text-zinc-400 mb-3 flex items-center gap-2">
                  <DollarSign className="w-4 h-4" />
                  Pasarela de Pago
                </label>
                <select
                  value={logistics.gateway}
                  onChange={(e) => updateLogistics('gateway', e.target.value)}
                  className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white font-semibold focus:outline-none focus:border-cyan-500 mb-5"
                >
                  {GATEWAYS.map(g => (
                    <option key={g.id} value={g.id}>
                      {g.name} {g.rate > 0 ? `(${g.rate}%)` : '(0%)'}
                    </option>
                  ))}
                </select>

                <label className="block text-sm text-zinc-400 mb-3 flex items-center gap-2">
                  <TrendingUp className="w-4 h-4" />
                  Margen de Ganancia
                </label>
                <div className="flex items-center gap-3">
                  <input
                    type="number"
                    value={logistics.profitMargin}
                    onChange={(e) => updateLogistics('profitMargin', parseFloat(e.target.value) || 0)}
                    className="w-24 bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-center text-2xl font-bold text-cyan-400 focus:outline-none focus:border-cyan-500"
                  />
                  <span className="text-2xl text-white">%</span>
                  <div className="text-xs text-zinc-500 flex-1">
                    ‚âà Multiplicar costos por <span className="text-white font-bold">{(1 / (1 - logistics.profitMargin / 100)).toFixed(1)}x</span>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Step 5: Results */}
          {step === 5 && results && (
            <div className="space-y-5 animate-fade-in">
              {/* Precio Principal */}
              <div className="text-center mb-8 bg-gradient-to-br from-zinc-900 to-zinc-800 rounded-3xl p-8 border border-zinc-700 shadow-2xl">
                <p className="text-zinc-500 text-xs uppercase tracking-widest mb-2">Precio a Cobrar</p>
                <h1 className="text-6xl font-black text-white mb-3 tracking-tight">
                  ${results.finalPrice.toLocaleString('es-CO')}
                </h1>
                <div className="flex justify-center gap-4 text-xs font-mono text-zinc-500">
                  <span>USD ${(results.finalPrice / 4100).toFixed(2)}</span>
                  <span>|</span>
                  <span>EUR ‚Ç¨{(results.finalPrice / 4400).toFixed(2)}</span>
                </div>
              </div>

              {/* Desglose */}
              <div className="bg-zinc-900 rounded-2xl border border-zinc-800 overflow-hidden">
                <div className="bg-zinc-800 p-3 text-center">
                  <span className="text-xs font-bold text-zinc-400 uppercase tracking-wider">Estructura de Costos</span>
                </div>
                
                <div className="p-5 space-y-4 text-sm">
                  <div className="flex justify-between items-center">
                    <span className="text-zinc-400">Costos Duros</span>
                    <span className="font-mono text-white font-bold">${results.hardCosts.toFixed(0).toLocaleString('es-CO')}</span>
                  </div>
                  <div className="text-xs text-zinc-600 pl-4 space-y-1">
                    <div className="flex justify-between">
                      <span>‚Ä¢ Energ√≠a</span>
                      <span>${results.breakdown.energy.toFixed(0).toLocaleString('es-CO')}</span>
                    </div>
                    <div className="flex justify-between">
                      <span>‚Ä¢ Desgaste</span>
                      <span>${results.breakdown.wear.toFixed(0).toLocaleString('es-CO')}</span>
                    </div>
                    <div className="flex justify-between">
                      <span>‚Ä¢ Material (con riesgos)</span>
                      <span>${results.breakdown.material.toFixed(0).toLocaleString('es-CO')}</span>
                    </div>
                  </div>

                  <div className="flex justify-between items-center">
                    <span className="text-zinc-400">Mano de Obra & BOM</span>
                    <span className="font-mono text-white font-bold">${results.softCosts.toFixed(0).toLocaleString('es-CO')}</span>
                  </div>
                  <div className="text-xs text-zinc-600 pl-4 space-y-1">
                    <div className="flex justify-between">
                      <span>‚Ä¢ Trabajo</span>
                      <span>${results.breakdown.labor.toFixed(0).toLocaleString('es-CO')}</span>
                    </div>
                    {results.breakdown.bom > 0 && (
                      <div className="flex justify-between">
                        <span>‚Ä¢ Componentes</span>
                        <span>${results.breakdown.bom.toFixed(0).toLocaleString('es-CO')}</span>
                      </div>
                    )}
                  </div>

                  <div className="flex justify-between items-center">
                    <span className="text-zinc-400">Log√≠stica</span>
                    <span className="font-mono text-white font-bold">${results.logisticsCosts.toFixed(0).toLocaleString('es-CO')}</span>
                  </div>

                  <div className="h-px bg-zinc-800" />

                  <div className="flex justify-between items-center text-lg pt-2">
                    <span className="text-cyan-400 font-bold">üí∞ Tu Ganancia Neta</span>
                    <span className="font-mono text-cyan-400 font-black">${results.netProfit.toFixed(0).toLocaleString('es-CO')}</span>
                  </div>

                  <div className="bg-cyan-500/10 border border-cyan-500/30 rounded-lg p-3 text-xs text-cyan-400">
                    ‚úÖ Esta ganancia es 100% limpia. Ya se descontaron todos los costos y comisiones.
                  </div>

                  {results.feeEstimate > 0 && (
                    <div className="flex justify-between items-center text-xs text-orange-400 pt-2 border-t border-zinc-800">
                      <span>Comisi√≥n Pasarela (ya incluida)</span>
                      <span className="font-mono">-${results.feeEstimate.toFixed(0).toLocaleString('es-CO')}</span>
                    </div>
                  )}
                </div>
              </div>

              {/* Acciones */}
              <div className="space-y-3 pt-4">
                <button
                  onClick={shareQuote}
                  className="w-full bg-gradient-to-r from-cyan-600 to-cyan-500 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-3 hover:from-cyan-500 hover:to-cyan-400 transition"
                >
                  <Share2 size={20} />
                  Copiar Resumen (WhatsApp)
                </button>

                <button
                  onClick={saveToHistory}
                  className="w-full bg-zinc-800 text-white font-bold py-4 rounded-xl border border-zinc-700 flex items-center justify-center gap-3 hover:bg-zinc-700 transition"
                >
                  <Share2 size={20} />
                  Guardar y Copiar Datos
                </button>

                <button
                  onClick={resetCalculator}
                  className="w-full bg-purple-600 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-3 hover:bg-purple-500 transition"
                >
                  <ArrowLeft size={20} />
                  Nueva Cotizaci√≥n
                </button>
              </div>
            </div>
          )}
        </div>
      </main>

      {/* Navigation Footer */}
      {step < 5 && (
        <footer className="fixed bottom-0 left-0 right-0 bg-zinc-900 border-t border-zinc-800 p-4 z-50">
          <div className="max-w-md mx-auto flex gap-3">
            {step > 1 && (
              <button
                onClick={prevStep}
                className="flex items-center justify-center gap-2 px-6 py-3 rounded-xl border border-zinc-700 text-zinc-400 bg-zinc-800 hover:bg-zinc-700 transition"
              >
                <ChevronLeft size={20} />
                Atr√°s
              </button>
            )}
            <button
              onClick={nextStep}
              className="flex-1 flex items-center justify-center gap-2 py-3 rounded-xl bg-gradient-to-r from-cyan-600 to-cyan-500 text-white font-bold shadow-lg hover:from-cyan-500 hover:to-cyan-400 transition"
            >
              {step === 4 ? 'CALCULAR' : 'Siguiente'}
              <ChevronRight size={20} />
            </button>
          </div>
        </footer>
      )}

      {/* BOM Dialog */}
      {showBomDialog && (
        <div className="fixed inset-0 bg-black/80 flex items-end z-50 animate-fade-in" onClick={() => setShowBomDialog(false)}>
          <div 
            className="bg-zinc-900 rounded-t-3xl p-6 w-full max-w-md mx-auto border-t border-zinc-700 animate-slide-up"
            onClick={(e) => e.stopPropagation()}
          >
            <h3 className="text-lg font-bold text-white mb-4">Agregar Componente</h3>
            <BomForm onSubmit={addBomItem} onCancel={() => setShowBomDialog(false)} />
          </div>
        </div>
      )}

      <style>{`
        @keyframes fade-in {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        @keyframes slide-up {
          from { transform: translateY(100%); }
          to { transform: translateY(0); }
        }
        .animate-fade-in {
          animation: fade-in 0.3s ease-out;
        }
        .animate-slide-up {
          animation: slide-up 0.3s ease-out;
        }
      `}</style>
    </div>
  );
}
